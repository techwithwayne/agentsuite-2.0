{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebDoctor Chat</title>

  <style>
    body {
      background-color: #121212;
    }
  </style>


  <script>
// ‚úÖ ENHANCED CONVERSATION RESET - GUARANTEED TO WORK
async function resetConversationOnLoad() {
    console.log('üîÑ Starting conversation reset...');
    
    try {
        // Method 1: Call the reset endpoint
        const response = await fetch('/agent/reset_conversation/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                force_reset: true,
                reason: 'page_load'
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Server-side conversation reset successful:', data);
        } else {
            console.warn('‚ö†Ô∏è Server-side reset failed, status:', response.status);
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Server-side reset error:', error);
    }
    
    // Method 2: Force reset via first message (BACKUP)
    try {
        console.log('üîÑ Sending force reset message...');
        const forceResetResponse = await fetch('/agent/handle_message/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                message: '__FORCE_RESET__',
                force_reset: true,
                lang: 'en'
            })
        });
        
        if (forceResetResponse.ok) {
            console.log('‚úÖ Force reset message sent successfully');
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Force reset message failed:', error);
    }
    
    console.log('üîÑ Conversation reset complete');
}

// ‚úÖ MULTIPLE RESET TRIGGERS - GUARANTEED TO FIRE
document.addEventListener('DOMContentLoaded', resetConversationOnLoad);
window.addEventListener('load', resetConversationOnLoad);

// Reset on page visibility change (when user comes back to tab)
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        setTimeout(resetConversationOnLoad, 100);
    }
});

// Reset when page is shown (back/forward navigation)
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        setTimeout(resetConversationOnLoad, 100);
    }
});
</script>

  <script>
    // ‚úÖ Declare once and reuse throughout the page
    window.isLocal = window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost";

    // ‚úÖ Dynamically load the CSS based on environment
    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = isLocal
      ? "https://127.0.0.1:8000/static/webdoctor/css/chat_widget.css"
      : "https://apps.techwithwayne.com/static/webdoctor/css/chat_widget.css";
    document.head.appendChild(cssLink);
  </script>
</head>
<body>
  <div class="chat-widget">
        <div id="chat-header">
            WebDoctor AI Assistant - Shirley
        </div>
        
        <div class="chat-body" id="chat-body">
            <!-- Messages will be dynamically added here -->
        </div>
        
        <div class="chat-input-wrapper">
            <input 
                type="text" 
                id="user-input" 
                placeholder="Describe your website issue..."
                maxlength="500"
            >
            <button id="send-button" type="button">‚û§</button>
        </div>
        
        <div class="form-section" id="form-section">
            <input 
                type="text" 
                id="form-name" 
                placeholder="Your Name"
                maxlength="100"
            >
            <input 
                type="email" 
                id="form-email" 
                placeholder="Your Email"
                maxlength="100"
            >
            <button id="submit-button" type="button">Get Free Diagnostic Report</button>
        </div>
    </div>

    <script>
        // Provide correct URLs to JavaScript
        window.webdoctorUrls = {
            handleMessage: "/agent/handle_message/",
            submitForm: "/agent/submit_form/"
        };
        console.log('üîß webdoctorUrls set to:', window.webdoctorUrls);
    </script>

  <script>
    // ‚úÖ Load JS dynamically and attach events AFTER it‚Äôs loaded
    const js = document.createElement("script");
    js.src = isLocal
      ? "https://127.0.0.1:8000/static/webdoctor/js/chat_widget.js"
      : "https://apps.techwithwayne.com/static/webdoctor/js/chat_widget.js?v=0.1.1.1.15";

    document.body.appendChild(js);
  </script>
</body>
</html>


